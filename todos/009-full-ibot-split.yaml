title: "Полное разбиение IBot на специализированные протоколы (ISP)"
status: done
created_at: 15.02.2026
completed_at: 15.02.2026

todoist:
  task_id: "6g2gGXWcV6pvfV6m"

description: |
  IBot содержит 11 методов. Каждый клиент использует только 1-3, но зависит от всего интерфейса.

  Текущие клиенты и используемые методы:
  - TelegramMessenger: send_message, edit_message_text, delete_message, send_document, get_file, download_file
  - CallbackAnswerer: answer_callback_query
  - CallbackHandlerRegistry: register_callback_query_handler
  - MessageHandlerRegistry: register_message_handler
  - NextStepHandlerRegistrar: register_next_step_handler
  - BotApplication: infinity_polling, setup_middleware (уже вынесен)

  Все обращения идут через IMessageCore.bot — это агрегатор, который тоже нужно пересмотреть.

recommendation: |
  1. Выделить протоколы по группам ответственности:
     - IMessageSenderBot: send_message, edit_message_text, delete_message, send_document
     - IFileDownloaderBot: get_file, download_file
     - ICallbackAnswererBot: answer_callback_query
     - IHandlerRegistrar: register_callback_query_handler, register_message_handler, register_next_step_handler
     - IPollingBot: infinity_polling
  2. Обновить каждый клиент — зависимость на свой узкий протокол вместо IBot
  3. Пересмотреть IMessageCore — вместо единого .bot предоставлять нужные протоколы
  4. Удалить IBot после того, как ни один клиент не зависит от него
  5. TeleBot реализует все протоколы через structural subtyping (Protocol)

solution: |
  Выполнено полное разбиение IBot согласно ISP:

  1. Создано 7 узких протоколов:
     - IMessageSenderBot (send_message, edit_message_text, delete_message, send_document)
     - IFileDownloaderBot (get_file, download_file)
     - ICallbackAnswererBot (answer_callback_query)
     - ICallbackHandlerRegistrarBot (register_callback_query_handler)
     - IMessageHandlerRegistrarBot (register_message_handler)
     - INextStepHandlerRegistrarBot (register_next_step_handler)
     - IPollingBot (infinity_polling)

  2. Обновлён IMessageCore:
     - Удалено свойство .bot
     - Добавлены свойства для каждого узкого протокола бота
     - Добавлены свойства для support chat протоколов (raw_forum_topic_creator, thread_message_sender, message_forwarder, middleware_setup)

  3. Обновлён TelegramMessageCore:
     - Добавлены свойства, возвращающие self.bot (TeleBot реализует все протоколы через structural subtyping)

  4. Обновлены все клиенты:
     - TelegramMessenger → message_sender_bot, file_downloader_bot
     - CallbackAnswerer → callback_answerer_bot
     - CallbackHandlerRegistry → callback_handler_registrar_bot
     - MessageHandlerRegistry → message_handler_registrar_bot
     - NextStepHandlerRegistrar → next_step_handler_registrar_bot
     - BotApplication → polling_bot, raw_forum_topic_creator, thread_message_sender, message_forwarder, middleware_setup

  5. Удалён IBot:
     - Файл i_bot.py удалён
     - Импорты удалены из всех __init__.py

  Результат:
  - Каждый клиент зависит только от методов, которые реально использует
  - Соблюдён Interface Segregation Principle
  - TeleBot продолжает работать без изменений благодаря structural subtyping
  - Все проверки пройдены: ruff, mypy, pyright, lint-imports
