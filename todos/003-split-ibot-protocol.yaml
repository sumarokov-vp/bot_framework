title: Разбить IBot на специализированные протоколы (ISP)
status: done
created_at: 15.02.2026
completed_at: 15.02.2026

todoist:
  task_id: "6g2g8gh4J2J7xc8m"

description: |
  IBot содержит 14 методов — god interface. Клиенты зависят от методов, которые не используют.
  Например, TelegramForumTopicCreator нужен только create_forum_topic,
  StaffReplyHandler — только send_message, SupportChatMiddleware — только forward_message.

recommendation: |
  Выделить специализированные протоколы: IMessageForwarder (forward_message).
  Использовать существующий IForumTopicCreator вместо метода в IBot.
  Обновить зависимости классов на узкие протоколы.

solution: |
  Созданы специализированные протоколы:
  - IMessageForwarder (bot_framework/core/protocols/i_message_forwarder.py) — форвардинг сообщений
  - IMiddlewareSetup (bot_framework/core/protocols/i_middleware_setup.py) — настройка middleware

  Удалены методы из IBot:
  - forward_message (перенесён в IMessageForwarder)
  - setup_middleware (перенесён в IMiddlewareSetup)
  - create_forum_topic (уже был удалён ранее, используется IForumTopicCreator)

  Обновлены зависимости:
  - SupportChatMiddleware теперь зависит от IMessageForwarder вместо object-типа bot
  - BotApplication передаёт bot как IMessageForwarder в SupportChatMiddleware

  Сигнатура IMessageForwarder.forward_message приведена в соответствие с TeleBot для совместимости типов.

  Проверки:
  - ruff check/format: ✓
  - mypy: ✓
  - pyright: ✓
  - lint-imports: ✓ (слои соблюдены)
